---
title: "p8105_hw6_iho2104"
author: "Ixtaccihuatl Obregon"
date: "`r Sys.Date()`"
output: github_document
---

```{r}
library(tidyverse)
library(boot)
library(broom)
library(purrr)
library(ggplot2)
```

# Problem 1 

```{r}

```

# Problem 2

Load weather data

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2022-01-01",
    date_max = "2022-12-31") |>
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |>
  select(name, id, everything())
```

Bootstrap and r_sq and log_product

```{r}

boot_straps = weather_df |> 
  modelr::bootstrap(n = 5000) |> 
  mutate(
    models = map(strap, ~lm(tmax ~ tmin + prcp, data = .)),
    results_1 = map(models, glance),
    results_2 = map(models, tidy)) |> 
  select(-strap, -models) |> 
  unnest() |>
  select(.id, r.squared, term, estimate) |> 
  filter(term !="(Intercept)") |> 
  pivot_wider(names_from = term, values_from = estimate) |> 
 mutate(
    tmin = as.numeric(tmin),
    prcp = as.numeric(prcp),
    log_product = log(tmin * prcp)
  )

```

Distribution

```{r}

ggplot(boot_straps, aes(x = r.squared)) +
  geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of R-squared Estimates",
       x = "R-squared",
       y = "Frequency")


ggplot(boot_straps, aes(x = log_product)) +
  geom_histogram(bins = 100, fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Distribution of log_product Estimates",
       x = "log_product",
       y = "Frequency")
```

CI Intervals

```{r}
r_sq_CI = 
boot_straps |> 
  group_by(.id) |> 
  summarize(
    ci_lower = quantile(r.squared, 0.025), 
    ci_upper = quantile(r.squared, 0.975))

log_product_CI = 
boot_straps |> 
  group_by(.id) |> 
  summarize(
    ci_lower = quantile(log_product, 0.025, na.rm = TRUE), 
    ci_upper = quantile(log_product, 0.975, na.rm = TRUE))

```

# Problem 3 

Load and clean the data

```{r}
birthweight_df = read.csv("birthweight.csv") 
str(birthweight_df)
summary(birthweight_df)

birthweight_df_tidy = birthweight_df |> 
  janitor::clean_names() |> 
  mutate( 
    gaweeks = as.factor(gaweeks),
    ppbmi = as.factor(ppbmi), 
    smoken = as.factor(smoken)
    )
str(birthweight_df_tidy)

missing_values = colSums(is.na(birthweight_df_tidy))
print(missing_values)

```

Regression model for birth weight 

```{r}
bwt_model_1 = lm(bwt ~ gaweeks + smoken, data = birthweight_df_tidy)
summary(bwt_graph_1)
augmented_data_1 = augment(bwt_model_1)
bwt_graph_1= ggplot(augmented_data_1, aes(x = .fitted, y = .resid)) +
  geom_point(color = "blue") +
  geom_smooth(method = "loess", color = "red") +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Residuals")
bwt_graph_1



bwt_model_2 = lm(bwt ~ blength + gaweeks , data = birthweight_df_tidy)
summary(bwt_model_2)
augmented_data_2 = augment(bwt_model_2)
bwt_graph_2 = ggplot(augmented_data_2, aes(x = .fitted, y = .resid)) +
  geom_point(color = "blue") +
  geom_smooth(method = "loess", color = "red") +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Residuals")
bwt_graph_2



bwt_model_3 = lm(bwt ~ bhead*blength*babysex , data = birthweight_df_tidy)
summary(bwt_model_3)
augmented_data_3 = augment(bwt_model_3)
bwt_graph_3 = ggplot(augmented_data_3, aes(x = .fitted, y = .resid)) +
  geom_point(color = "blue") +
  geom_smooth(method = "loess", color = "red") +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Residuals")
bwt_graph_3
```

Comparing 

```{r}
models = list(bwt_model_1, bwt_model_2, bwt_model_3)
model_names = c("bwt_model_1", "bwt_model_2", "bwt_model_3")
calculate_cv_error = function(model, birthweight_df_tidy) {
        cv_results = crossv_mc(model, birthweight_df_tidy, trControl = trainControl(method = "cv"))
  return(mean(cv_results$results$RMSE))
}
cv_errors = map_dbl(models, ~calculate_cv_error(.x, birthweight_df_tidy))
comparison = data.frame(Model =model_names, CV_errors = cv_errors)
print(comparison)
```
